<!DOCTYPE html>
<html>
<head>
    <title>Voting App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: calc(100vh - 40px); /* Adjust for margin */
        }
    </style>
</head>
<body>
    <h1 id="pollQuestionTitle" class="text-4xl text-gray-800 mb-8 text-center">Loading Poll...</h1>

    <div id="voteButtonsContainer" class="flex flex-wrap justify-center space-x-4 mb-12">
        <!-- Vote buttons will be dynamically inserted here -->
    </div>

    <h2 class="text-3xl text-gray-700 mb-4">Live Results</h2>
    <pre id="results"
         class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 text-gray-800 text-lg font-mono min-w-min w-1/2 text-left overflow-auto">
        Loading results...
    </pre>

    <script>
        let currentPollOptions = []; // To store options for dynamic result display
        // Function to cast a vote
        async function vote(candidateName) {
            const errorMessageElement = document.getElementById("results"); // Or a dedicated error element for voting
            try {
                const response = await fetch(`http://localhost:8000/vote?option=${encodeURIComponent(candidateName)}`, {
                    method: "POST"
                });

                if (response.ok) {
                    console.log(`Vote for ${candidateName} successfully cast!`);
                    // Immediately fetch results after voting to show updated count
                    fetchResults();
                } else {
                    const errorData = await response.json();
                    const detail = errorData.detail || 'Unknown error during vote.';
                    console.error('Error casting vote:', detail);
                    // Display error more gracefully if possible, e.g., in the results area or a dedicated spot
                    errorMessageElement.innerText = `Error casting vote: ${detail}`;
                }
            } catch (error) {
                console.error('Network error during vote:', error);
                errorMessageElement.innerText = 'A network error occurred while voting. Please check your connection.';
            }
        }

        // Function to fetch and display results
        async function fetchAndDisplayResults() {
            const resultsElement = document.getElementById("results");
            try {
                const response = await fetch('http://localhost:8001/results'); // Corrected port for result-api
                if (response.ok) {
                    const data = await response.json();
                    let resultsText = "";
                    if (currentPollOptions.length > 0) {
                        currentPollOptions.forEach(option => {
                            resultsText += `${option}: ${data[option] !== undefined ? data[option] : "0"}\n`;
                        });
                    } else if (Object.keys(data).length > 0 && !data.error) { // Fallback if options not set but results exist
                         Object.entries(data).forEach(([key, value]) => {
                            if (!key.startsWith('_')) { // Exclude metadata like _poll_question
                                resultsText += `${key}: ${value}\n`;
                            }
                        });
                    } else {
                        resultsText = "No results available or poll not fully loaded.";
                    }
                    resultsElement.innerText = resultsText.trim() || "Waiting for votes...";
                } else {
                    console.error('Failed to fetch results:', response.status, response.statusText);
                    resultsElement.innerText = "Failed to load results. Poll might have been deleted or API is down.";
                }
            } catch (error) {
                console.error('Network error fetching results:', error);
                resultsElement.innerText = "Error fetching results. API might be down.";
            }
        }

        // Function to load active poll and set up the page
        async function loadActivePoll() {
            const pollQuestionTitle = document.getElementById('pollQuestionTitle');
            const voteButtonsContainer = document.getElementById('voteButtonsContainer');
            try {
                const response = await fetch('http://localhost:8000/polls/active'); // Updated endpoint
                if (!response.ok) {
                    pollQuestionTitle.textContent = 'No Active Poll';
                    voteButtonsContainer.innerHTML = '<p class="text-gray-600">There is no active poll to vote on currently.</p>';
                    document.getElementById("results").innerText = "No active poll.";
                    return;
                }
                const poll = await response.json();
                pollQuestionTitle.textContent = poll.question;
                currentPollOptions = poll.options; // Store options
                voteButtonsContainer.innerHTML = ''; // Clear previous buttons
                poll.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = `Vote for ${option}`;
                    button.className = 'bg-indigo-600 text-white py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 ease-in-out text-xl font-semibold mb-2';
                    button.onclick = () => vote(option);
                    voteButtonsContainer.appendChild(button);
                });
                fetchAndDisplayResults(); // Fetch results for the loaded poll
            } catch (error) {
                pollQuestionTitle.textContent = 'Error Loading Poll';
                console.error('Error fetching active poll:', error);
                document.getElementById("results").innerText = "Could not load poll information.";
            }
        }

        // Load active poll when the page loads
        loadActivePoll();

        // Refresh results every 2 seconds (2000 milliseconds)
        setInterval(fetchAndDisplayResults, 2000);
    </script>
</body>
</html>